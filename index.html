<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì„œìš¸ ë”°ë¦‰ì´ ì§€ë„ + AI ì±„íŒ…</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Markdown + Sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <!-- Google Generative AI (ESM in browser) -->
  <script type="module" id="genai-loader">
    // ë¹ˆ ëª¨ë“ˆ: ë³¸ë¬¸ì—ì„œ ë‹¤ì‹œ importí•©ë‹ˆë‹¤(ì¼ë¶€ CSP ìš°íšŒìš©).
  </script>

  <style>
    :root{
      --green-50:#f0fdf4; --green-100:#dcfce7; --green-200:#bbf7d0; --green-300:#86efac;
      --green-400:#4ade80; --green-500:#22c55e; --green-600:#16a34a; --green-700:#15803d;
      --ink:#0b1b13; --muted:#54735f; --border:#e5f7ea; --shadow:0 6px 28px rgba(21,128,61,.10);
      --bg:white;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--green-50);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,sans-serif}
    .app{display:flex;height:100%;gap:14px;padding:14px}
    .panel{background:var(--bg);border:1px solid var(--green-200);border-radius:16px;box-shadow:var(--shadow)}
    /* ì¢Œ: ì§€ë„ */
    #map-wrap{flex:1;position:relative;min-width:320px}
    #map{position:absolute;inset:0;border-radius:16px}
    .map-title,.map-controls{
      position:absolute;z-index:1000;background:rgba(240,253,244,.95);border:1px solid var(--green-200);
      border-radius:12px;padding:8px 10px;box-shadow:0 2px 10px rgba(21,128,61,.08);color:var(--ink)
    }
    .map-title{left:12px;top:12px;font-weight:800}
    .map-controls{right:12px;top:12px;display:flex;gap:8px;align-items:center}
    .btn{border:1px solid var(--green-200);border-radius:10px;padding:7px 10px;background:#fff;cursor:pointer;user-select:none}
    .btn:hover{background:var(--green-100)}
    .btn.active{border-color:var(--green-500);box-shadow:0 0 0 2px var(--green-100) inset;font-weight:800}

    /* ì•„ì´ì½˜ */
    .bike-pin{
      width:28px;height:28px;border-radius:50%;background:var(--green-500);color:#fff;display:flex;align-items:center;justify-content:center;
      font-size:16px;line-height:1;box-shadow:0 2px 8px rgba(21,128,61,.30);transform:translate(-14px,-14px);border:2px solid #fff
    }
    .marker-cluster-small,.marker-cluster-medium,.marker-cluster-large{background:var(--green-400);color:#0b1b13;border:2px solid #fff}
    .marker-cluster div{
      background:var(--green-500);color:#fff;border-radius:50%;border:2px solid #fff;font:800 12px/26px system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      width:28px;height:28px;box-shadow:0 2px 8px rgba(21,128,61,.25);
    }
    .leaflet-popup-content{margin:8px 10px}
    .leaflet-popup-content b{font-size:14px}
    .leaflet-popup-content small{color:#2b4739}

    /* ìš°: ì±„íŒ… */
    #chat{width:420px;min-width:320px;display:flex;flex-direction:column}
    .chat-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .chat-title{font-weight:800}
    .chat-actions{display:flex;gap:8px}
    .pill{border:1px solid var(--green-200);background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}
    .pill:hover{background:var(--green-100)}
    .settings{padding:12px 14px;border-bottom:1px solid var(--border);display:none;gap:8px;flex-wrap:wrap}
    .settings.open{display:flex}
    .settings input{flex:1 1 100%;padding:10px;border:1px solid var(--green-200);border-radius:10px}
    .settings small{color:var(--muted)}
    .chat-body{flex:1;overflow:auto;padding:14px;scroll-behavior:smooth}
    .msg{display:flex;gap:10px;margin-bottom:14px}
    .msg .avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--green-500);color:white;font-size:14px}
    .msg.user .avatar{background:#111}
    .bubble{max-width:85%;padding:10px 12px;border:1px solid var(--green-200);border-radius:12px;background:#fff}
    .msg.user .bubble{background:#111;color:#fff;border-color:#111}
    .msg.assistant .bubble{background:#fff}
    .bubble .md{overflow:auto}
    .typing{display:inline-block;min-width:56px}
    .dots:after{content:"";display:inline-block;width:1.2em;animation:blink 1s steps(4,end) infinite}
    @keyframes blink {0%{content:"."}25%{content:".."}50%{content:"..."}75%{content:"...."}100%{content:"."}}
    .chat-input{border-top:1px solid var(--border);padding:10px;display:flex;gap:8px}
    textarea{flex:1;resize:none;min-height:44px;max-height:160px;padding:10px;border:1px solid var(--green-200);border-radius:12px}
    .send{min-width:44px;border-radius:12px;border:1px solid var(--green-200);background:var(--green-500);color:white;font-weight:700;cursor:pointer}
    .send:disabled{opacity:.6;cursor:not-allowed}

    /* ë°˜ì‘í˜•: ì¢ì€ í™”ë©´ì—ì„œëŠ” ìƒí•˜ ë°°ì¹˜ */
    @media (max-width: 980px){
      .app{flex-direction:column}
      #chat{width:100%;min-height:45vh}
      #map-wrap{height:55vh}
    }

    @media (prefers-color-scheme: dark){
      html,body{background:#0a1510;color:#e8f6ed}
      .panel{background:#0f2419;border-color:#163d2a}
      .map-title,.map-controls{background:rgba(12,28,20,.9);border-color:#163d2a;color:#e8f6ed}
      .btn,.pill{background:#0f2419;border-color:#163d2a;color:#e8f6ed}
      .btn:hover,.pill:hover{background:#0b1b13}
      textarea,.settings input{background:#0f2419;color:#e8f6ed;border-color:#163d2a}
      .bubble{background:#0f2419;color:#e8f6ed;border-color:#163d2a}
      .msg.user .bubble{background:#111;color:#fff;border-color:#222}
      .avatar{border:1px solid #163d2a}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Left: Map -->
    <section id="map-wrap" class="panel">
      <div id="map"></div>
      <div class="map-title">ì„œìš¸ ë”°ë¦‰ì´ ëŒ€ì—¬ì†Œ ì§€ë„</div>
      <div class="map-controls">
        ë³´ê¸°:
        <button id="btn-cluster" class="btn active">ë§ˆì»¤ í•©ì¹˜ê¸°</button>
        <button id="btn-plain" class="btn">ê·¸ëŒ€ë¡œ ë³´ê¸°</button>
        <button id="btn-recenter" class="btn" title="ëŒ€ì—¬ì†Œ ë²”ìœ„ë¡œ ë‹¤ì‹œ ë§ì¶”ê¸°">ì´ˆê¸°í™”</button>
      </div>
    </section>

    <!-- Right: Chat -->
    <aside id="chat" class="panel">
      <div class="chat-head">
        <div class="chat-title">ì¸ê³µì§€ëŠ¥ ì±—ë´‡</div>
        <div class="chat-actions">
          <button id="toggle-settings" class="pill">API ì„¤ì •</button>
          <button id="clear-chat" class="pill" title="ëŒ€í™” ë‚´ìš© ì‚­ì œ">ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div class="settings" id="settings">
        <input id="apiKey" type="password" placeholder="ì—¬ê¸°ì— Google Generative AI API í‚¤ë¥¼ ë¶™ì—¬ë„£ê³  ì €ì¥í•˜ì„¸ìš”" />
        <div style="display:flex;gap:8px;align-items:center;width:100%">
          <button id="saveKey" class="pill">í‚¤ ì €ì¥</button>
          <small>ëª¨ë¸: <b>models/gemini-2.5-pro</b> (ê³ ì •, ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í˜¸ì¶œ)</small>
        </div>
      </div>
      <div id="chat-body" class="chat-body" aria-live="polite"></div>
      <div class="chat-input">
        <textarea id="prompt" placeholder="ë”°ë¦‰ì´, ë‚˜ë“¤ì´ ì½”ìŠ¤, í™˜ìŠ¹Â·ìì „ê±° ê¸¸ ë“± ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•˜ì„¸ìš”. (Enter=ì „ì†¡, Shift+Enter=ì¤„ë°”ê¿ˆ)"></textarea>
        <button id="send" class="send">ë³´ë‚´ê¸°</button>
      </div>
    </aside>
  </div>

  <script>
    /* =======================
       1) ì§€ë„ ì´ˆê¸°í™”
       ======================= */
    const map = L.map('map', { center: [37.5665, 126.9780], zoom: 12, scrollWheelZoom: true });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    const clusterLayer = L.markerClusterGroup({ showCoverageOnHover: false, spiderfyOnMaxZoom: true });
    const plainLayer   = L.layerGroup();
    const bikeIcon = L.divIcon({ className: 'bike-pin', html: 'ğŸš²', iconSize: [28,28], iconAnchor:[14,14], popupAnchor:[0,-12] });

    let _bounds = [];
    fetch('stations.json', { cache: 'no-store' })
      .then(r => { if(!r.ok) throw new Error('stations.jsonì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return r.json(); })
      .then(stores => {
        _bounds = [];
        stores.forEach(s=>{
          if (!Number.isFinite(s.lat) || !Number.isFinite(s.lng)) return;
          const popup = `
            <div>
              <b>${esc(s.name ?? '')}</b><br/>
              <small>${esc(s.district ?? '')}</small><br/>
              <small>${esc(s.address ?? '')}</small><br/>
              <small>ê±°ì¹˜ëŒ€ìˆ˜: ${s.capacity ?? '-'}</small><br/>
              ${s.installed_at ? `<small>ì„¤ì¹˜: ${esc(s.installed_at)}</small><br/>` : ''}
              <a href="https://www.google.com/maps?q=${s.lat},${s.lng}" target="_blank" rel="noopener">êµ¬ê¸€ì§€ë„ ì—´ê¸°</a>
            </div>`;
          const m1 = L.marker([s.lat, s.lng], { icon: bikeIcon }).bindPopup(popup);
          const m2 = L.marker([s.lat, s.lng], { icon: bikeIcon }).bindPopup(popup);
          clusterLayer.addLayer(m1);
          plainLayer.addLayer(m2);
          _bounds.push([s.lat, s.lng]);
        });
        map.addLayer(clusterLayer);
        if (_bounds.length) map.fitBounds(_bounds, { padding:[24,24] });
      })
      .catch(err => { console.error(err); alert('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜: '+err.message); });

    function esc(str){ return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // í† ê¸€/ì´ˆê¸°í™”
    const btnCluster = document.getElementById('btn-cluster');
    const btnPlain   = document.getElementById('btn-plain');
    const btnRecenter= document.getElementById('btn-recenter');

    btnCluster.addEventListener('click', ()=>{
      if (map.hasLayer(clusterLayer)) return;
      map.removeLayer(plainLayer); map.addLayer(clusterLayer);
      btnCluster.classList.add('active'); btnPlain.classList.remove('active');
    });
    btnPlain.addEventListener('click', ()=>{
      if (map.hasLayer(plainLayer)) return;
      map.removeLayer(clusterLayer); map.addLayer(plainLayer);
      btnPlain.classList.add('active'); btnCluster.classList.remove('active');
    });
    btnRecenter.addEventListener('click', ()=>{
      if (_bounds.length) map.fitBounds(_bounds, { padding:[24,24] });
    });

    /* =======================
       2) ì±„íŒ… UI
       ======================= */
    const chatBody = document.getElementById('chat-body');
    const promptEl = document.getElementById('prompt');
    const sendBtn  = document.getElementById('send');
    const toggleSettings = document.getElementById('toggle-settings');
    const settings  = document.getElementById('settings');
    const apiKeyEl  = document.getElementById('apiKey');
    const saveKey   = document.getElementById('saveKey');
    const clearBtn  = document.getElementById('clear-chat');

    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ í‚¤ ë¡œë“œ
    const KEY_NAME = 'gemini_api_key';
    apiKeyEl.value = localStorage.getItem(KEY_NAME) || '';

    toggleSettings.addEventListener('click', ()=> settings.classList.toggle('open'));
    saveKey.addEventListener('click', ()=>{
      localStorage.setItem(KEY_NAME, apiKeyEl.value.trim());
      alert('API í‚¤ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
      settings.classList.remove('open');
    });

    clearBtn.addEventListener('click', ()=>{
      if (confirm('ëŒ€í™” ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš¸ê¹Œìš”?')) {
        chatBody.innerHTML = '';
        historyMsgs.length = 0;
      }
    });

    // Enter = ì „ì†¡, Shift+Enter = ì¤„ë°”ê¿ˆ
    promptEl.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); send();
      }
    });
    sendBtn.addEventListener('click', send);

    // íˆìŠ¤í† ë¦¬(ê°„ë‹¨): [{role:'user'|'model', parts:[{text}]}]
    const historyMsgs = [];

    function addMsg(role, html){
      const wrap = document.createElement('div');
      wrap.className = `msg ${role}`;
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = role==='user' ? 'ğŸ™‹' : 'ğŸ¤–';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      const md = document.createElement('div');
      md.className = 'md';
      md.innerHTML = html;
      bubble.appendChild(md);
      wrap.appendChild(avatar);
      wrap.appendChild(bubble);
      chatBody.appendChild(wrap);
      chatBody.scrollTop = chatBody.scrollHeight;
      return wrap;
    }

    function addTyping(){
      const wrap = document.createElement('div');
      wrap.className = 'msg assistant';
      wrap.innerHTML = `
        <div class="avatar">ğŸ¤–</div>
        <div class="bubble"><span class="typing"><span class="dots"></span></span> ì…ë ¥ì¤‘</div>
      `;
      chatBody.appendChild(wrap);
      chatBody.scrollTop = chatBody.scrollHeight;
      return wrap;
    }

    function mdToHtml(text){
      const raw = marked.parse(text, { breaks:true });
      return DOMPurify.sanitize(raw);
    }

    async function send(){
      const text = promptEl.value.trim();
      if (!text) return;
      const apiKey = (apiKeyEl.value || localStorage.getItem(KEY_NAME) || '').trim();
      if (!apiKey){ alert('API í‚¤ë¥¼ ì…ë ¥ í›„ ì €ì¥í•˜ì„¸ìš”.'); settings.classList.add('open'); return; }

      // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶œë ¥
      addMsg('user', mdToHtml(text));
      promptEl.value = '';
      promptEl.style.height = '44px';

      // íƒ€ì´í•‘ í‘œì‹œ
      const typingEl = addTyping();
      sendBtn.disabled = true;

      try{
        // ë™ì  import (ë¸Œë¼ìš°ì € ESM)
        const { GoogleGenerativeAI } = await import('https://esm.run/@google/generative-ai');

        // ëª¨ë¸ ì¤€ë¹„ (ê³ ì • ëª¨ë¸ëª…)
        const genAI = new GoogleGenerativeAI(apiKey);
        const model = genAI.getGenerativeModel({
          model: 'models/gemini-2.5-pro',
          // ë„ë©”ì¸ ì§€ì‹œ: ë”°ë¦‰ì´/ë‚˜ë“¤ì´ íŠ¹í™” + ê°„ê²°Â·ì •í™•
          systemInstruction: `
ë‹¹ì‹ ì€ ì„œìš¸ 'ë”°ë¦‰ì´' ëŒ€ì—¬ì†ŒÂ·ìì „ê±° ê¸¸Â·ë‚˜ë“¤ì´ ì½”ìŠ¤ë¥¼ ë„ì™€ì£¼ëŠ” í•œêµ­ì–´ ë¹„ì„œì…ë‹ˆë‹¤.
ê·œì¹™:
1) ì¶”ì¸¡ ê¸ˆì§€. ë¶ˆí™•ì‹¤í•˜ë©´ "í™•ì‹¤í•˜ì§€ ì•ŠìŒ"ì´ë¼ ë§í•˜ê³  ëŒ€ì•ˆì„ ì œì‹œ.
2) ìš”ì  ìœ„ì£¼, ê°„ê²°í•˜ê³  ê³µì ì¸ í†¤. ê³¼ì¥ ê¸ˆì§€.
3) ì•ˆì „ ìˆ˜ì¹™Â·ëŒ€ì¤‘êµí†µ í™˜ìŠ¹Â·ìì „ê±° ë„ë¡œ/ê³µì›Â·ì£¼ë§ ì½”ìŠ¤ ë“± ì‹¤ìš© íŒì„ ë¨¼ì €.
4) ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ë¦¬ìŠ¤íŠ¸/ë§í¬/ì†Œì œëª©ì„ ì •ë¦¬.
5) ë²•/ìš”ê¸ˆ/ìš´ì˜ ì •ë³´ëŠ” ë³€ë™ ê°€ëŠ¥ì„±ì„ í•¨ê»˜ ê³ ì§€.
          `.trim()
        });

        // ëŒ€í™” ì‹œì‘(ê°„ë‹¨ íˆìŠ¤í† ë¦¬ ì „ë‹¬)
        const chat = model.startChat({ history: historyMsgs });

        const result = await chat.sendMessage(text);
        const reply = (await result.response.text()) || '';

        // íˆìŠ¤í† ë¦¬ ê°±ì‹ 
        historyMsgs.push({ role: 'user',  parts:[{text}] });
        historyMsgs.push({ role: 'model', parts:[{text: reply}] });

        // íƒ€ì´í•‘ ì œê±° í›„ ë‹µë³€ ì¶œë ¥
        typingEl.remove();
        addMsg('assistant', mdToHtml(reply));
      }catch(err){
        console.error(err);
        typingEl.remove();
        addMsg('assistant', mdToHtml(`**ì˜¤ë¥˜**: ìš”ì²­ì„ ì²˜ë¦¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n\n- ${String(err.message || err)}`));
      }finally{
        sendBtn.disabled = false;
      }
    }

    // ìë™ ë†’ì´
    promptEl.addEventListener('input', ()=>{
      promptEl.style.height = 'auto';
      promptEl.style.height = Math.min(promptEl.scrollHeight, 160) + 'px';
    });
  </script>
</body>
</html>
